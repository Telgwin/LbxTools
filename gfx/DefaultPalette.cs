using System;
using System.IO;
using ImageSharp;
using Tool.Core;

namespace Tool.Gfx
{
    internal class Painter
    {
        public Painter(Image<Rgba32> img)
        {
            Img = img;
        }

        private uint[][] palette =
            { new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x8,  0x4,  0x4 },
            new uint[] { 0x24, 0x1c, 0x18 },
            new uint[] { 0x38, 0x30, 0x2c },
            new uint[] { 0x48, 0x40, 0x3c },
            new uint[] { 0x58, 0x50, 0x4c },
            new uint[] { 0x68, 0x60, 0x5c },
            new uint[] { 0x7c, 0x74, 0x70 },
            new uint[] { 0x8c, 0x84, 0x80 },
            new uint[] { 0x9c, 0x94, 0x90 },
            new uint[] { 0xac, 0xa4, 0xa0 },
            new uint[] { 0xc0, 0xb8, 0xb4 },
            new uint[] { 0xd0, 0xc8, 0xc4 },
            new uint[] { 0xe0, 0xd8, 0xd4 },
            new uint[] { 0xf0, 0xe8, 0xe4 },
            new uint[] { 0xfc, 0xfc, 0xfc },
            new uint[] { 0x38, 0x20, 0x1c },
            new uint[] { 0x40, 0x2c, 0x24 },
            new uint[] { 0x48, 0x34, 0x2c },
            new uint[] { 0x50, 0x3c, 0x30 },
            new uint[] { 0x58, 0x40, 0x34 },
            new uint[] { 0x5c, 0x44, 0x38 },
            new uint[] { 0x60, 0x48, 0x3c },
            new uint[] { 0x64, 0x4c, 0x3c },
            new uint[] { 0x68, 0x50, 0x40 },
            new uint[] { 0x70, 0x54, 0x44 },
            new uint[] { 0x78, 0x5c, 0x4c },
            new uint[] { 0x80, 0x64, 0x50 },
            new uint[] { 0x8c, 0x70, 0x58 },
            new uint[] { 0x94, 0x74, 0x5c },
            new uint[] { 0x9c, 0x7c, 0x64 },
            new uint[] { 0xa4, 0x84, 0x68 },
            new uint[] { 0xec, 0xc0, 0xd4 },
            new uint[] { 0xd4, 0x98, 0xb4 },
            new uint[] { 0xbc, 0x74, 0x94 },
            new uint[] { 0xa4, 0x54, 0x7c },
            new uint[] { 0x8c, 0x38, 0x60 },
            new uint[] { 0x74, 0x24, 0x4c },
            new uint[] { 0x5c, 0x10, 0x34 },
            new uint[] { 0x44, 0x4,  0x20 },
            new uint[] { 0xec, 0xc0, 0xc0 },
            new uint[] { 0xd4, 0x94, 0x94 },
            new uint[] { 0xbc, 0x74, 0x74 },
            new uint[] { 0xa4, 0x54, 0x54 },
            new uint[] { 0x8c, 0x38, 0x38 },
            new uint[] { 0x74, 0x24, 0x24 },
            new uint[] { 0x5c, 0x10, 0x10 },
            new uint[] { 0x44, 0x4,  0x4 },
            new uint[] { 0xec, 0xd4, 0xc0 },
            new uint[] { 0xd4, 0xb4, 0x98 },
            new uint[] { 0xbc, 0x98, 0x74 },
            new uint[] { 0xa4, 0x7c, 0x54 },
            new uint[] { 0x8c, 0x60, 0x38 },
            new uint[] { 0x74, 0x4c, 0x24 },
            new uint[] { 0x5c, 0x34, 0x10 },
            new uint[] { 0x44, 0x24, 0x4 },
            new uint[] { 0xec, 0xec, 0xc0 },
            new uint[] { 0xd4, 0xd4, 0x94 },
            new uint[] { 0xbc, 0xbc, 0x74 },
            new uint[] { 0xa4, 0xa4, 0x54 },
            new uint[] { 0x8c, 0x8c, 0x38 },
            new uint[] { 0x74, 0x74, 0x24 },
            new uint[] { 0x5c, 0x5c, 0x10 },
            new uint[] { 0x44, 0x44, 0x4 },
            new uint[] { 0xd4, 0xec, 0xbc },
            new uint[] { 0xb8, 0xd4, 0x98 },
            new uint[] { 0x98, 0xbc, 0x74 },
            new uint[] { 0x7c, 0xa4, 0x54 },
            new uint[] { 0x60, 0x8c, 0x38 },
            new uint[] { 0x4c, 0x74, 0x24 },
            new uint[] { 0x38, 0x5c, 0x10 },
            new uint[] { 0x24, 0x44, 0x4 },
            new uint[] { 0xc0, 0xec, 0xc0 },
            new uint[] { 0x98, 0xd4, 0x98 },
            new uint[] { 0x74, 0xbc, 0x74 },
            new uint[] { 0x54, 0xa4, 0x54 },
            new uint[] { 0x38, 0x8c, 0x38 },
            new uint[] { 0x24, 0x74, 0x24 },
            new uint[] { 0x10, 0x5c, 0x10 },
            new uint[] { 0x4,  0x44, 0x4 },
            new uint[] { 0xc0, 0xec, 0xd8 },
            new uint[] { 0x98, 0xd4, 0xb8 },
            new uint[] { 0x74, 0xbc, 0x98 },
            new uint[] { 0x54, 0xa4, 0x7c },
            new uint[] { 0x38, 0x8c, 0x60 },
            new uint[] { 0x24, 0x74, 0x4c },
            new uint[] { 0x10, 0x5c, 0x38 },
            new uint[] { 0x4,  0x44, 0x24 },
            new uint[] { 0xf4, 0xc0, 0xa0 },
            new uint[] { 0xe0, 0xa0, 0x84 },
            new uint[] { 0xcc, 0x84, 0x6c },
            new uint[] { 0xc8, 0x8c, 0x68 },
            new uint[] { 0xa8, 0x78, 0x54 },
            new uint[] { 0x98, 0x68, 0x4c },
            new uint[] { 0x8c, 0x60, 0x44 },
            new uint[] { 0x7c, 0x50, 0x3c },
            new uint[] { 0xc0, 0xd8, 0xec },
            new uint[] { 0x94, 0xb4, 0xd4 },
            new uint[] { 0x70, 0x98, 0xbc },
            new uint[] { 0x54, 0x7c, 0xa4 },
            new uint[] { 0x38, 0x64, 0x8c },
            new uint[] { 0x24, 0x4c, 0x74 },
            new uint[] { 0x10, 0x38, 0x5c },
            new uint[] { 0x4,  0x24, 0x44 },
            new uint[] { 0xc0, 0xc0, 0xec },
            new uint[] { 0x98, 0x98, 0xd4 },
            new uint[] { 0x74, 0x74, 0xbc },
            new uint[] { 0x54, 0x54, 0xa4 },
            new uint[] { 0x3c, 0x38, 0x8c },
            new uint[] { 0x24, 0x24, 0x74 },
            new uint[] { 0x10, 0x10, 0x5c },
            new uint[] { 0x4,  0x4,  0x44 },
            new uint[] { 0xd8, 0xc0, 0xec },
            new uint[] { 0xb8, 0x98, 0xd4 },
            new uint[] { 0x98, 0x74, 0xbc },
            new uint[] { 0x7c, 0x54, 0xa4 },
            new uint[] { 0x60, 0x38, 0x8c },
            new uint[] { 0x4c, 0x24, 0x74 },
            new uint[] { 0x38, 0x10, 0x5c },
            new uint[] { 0x24, 0x4,  0x44 },
            new uint[] { 0xec, 0xc0, 0xec },
            new uint[] { 0xd4, 0x98, 0xd4 },
            new uint[] { 0xbc, 0x74, 0xbc },
            new uint[] { 0xa4, 0x54, 0xa4 },
            new uint[] { 0x8c, 0x38, 0x8c },
            new uint[] { 0x74, 0x24, 0x74 },
            new uint[] { 0x5c, 0x10, 0x5c },
            new uint[] { 0x44, 0x4,  0x44 },
            new uint[] { 0xd8, 0xd0, 0xd0 },
            new uint[] { 0xc0, 0xb0, 0xb0 },
            new uint[] { 0xa4, 0x90, 0x90 },
            new uint[] { 0x8c, 0x74, 0x74 },
            new uint[] { 0x78, 0x5c, 0x5c },
            new uint[] { 0x68, 0x4c, 0x4c },
            new uint[] { 0x5c, 0x3c, 0x3c },
            new uint[] { 0x48, 0x2c, 0x2c },
            new uint[] { 0xd0, 0xd8, 0xd0 },
            new uint[] { 0xb0, 0xc0, 0xb0 },
            new uint[] { 0x90, 0xa4, 0x90 },
            new uint[] { 0x74, 0x8c, 0x74 },
            new uint[] { 0x5c, 0x78, 0x5c },
            new uint[] { 0x4c, 0x68, 0x4c },
            new uint[] { 0x3c, 0x5c, 0x3c },
            new uint[] { 0x2c, 0x48, 0x2c },
            new uint[] { 0xc8, 0xc8, 0xd4 },
            new uint[] { 0xb0, 0xb0, 0xc0 },
            new uint[] { 0x90, 0x90, 0xa4 },
            new uint[] { 0x74, 0x74, 0x8c },
            new uint[] { 0x5c, 0x5c, 0x78 },
            new uint[] { 0x4c, 0x4c, 0x68 },
            new uint[] { 0x3c, 0x3c, 0x5c },
            new uint[] { 0x2c, 0x2c, 0x48 },
            new uint[] { 0xd8, 0xdc, 0xec },
            new uint[] { 0xc8, 0xcc, 0xdc },
            new uint[] { 0xb8, 0xc0, 0xd4 },
            new uint[] { 0xa8, 0xb8, 0xcc },
            new uint[] { 0x9c, 0xb0, 0xcc },
            new uint[] { 0x94, 0xac, 0xcc },
            new uint[] { 0x88, 0xa4, 0xcc },
            new uint[] { 0x88, 0x94, 0xdc },
            new uint[] { 0xfc, 0xf0, 0x90 },
            new uint[] { 0xfc, 0xe4, 0x60 },
            new uint[] { 0xfc, 0xc8, 0x24 },
            new uint[] { 0xfc, 0xac, 0xc },
            new uint[] { 0xfc, 0x78, 0x10 },
            new uint[] { 0xd0, 0x1c, 0x0 },
            new uint[] { 0x98, 0x0,  0x0 },
            new uint[] { 0x58, 0x0,  0x0 },
            new uint[] { 0x90, 0xf0, 0xfc },
            new uint[] { 0x60, 0xe4, 0xfc },
            new uint[] { 0x24, 0xc8, 0xfc },
            new uint[] { 0xc,  0xac, 0xfc },
            new uint[] { 0x10, 0x78, 0xfc },
            new uint[] { 0x0,  0x1c, 0xd0 },
            new uint[] { 0x0,  0x0,  0x98 },
            new uint[] { 0x0,  0x0,  0x58 },
            new uint[] { 0xfc, 0xc8, 0x64 },
            new uint[] { 0xfc, 0xb4, 0x2c },
            new uint[] { 0xec, 0xa4, 0x24 },
            new uint[] { 0xdc, 0x94, 0x1c },
            new uint[] { 0xcc, 0x88, 0x18 },
            new uint[] { 0xbc, 0x7c, 0x14 },
            new uint[] { 0xa4, 0x6c, 0x1c },
            new uint[] { 0x8c, 0x60, 0x24 },
            new uint[] { 0x78, 0x54, 0x24 },
            new uint[] { 0x60, 0x44, 0x24 },
            new uint[] { 0x48, 0x38, 0x24 },
            new uint[] { 0x34, 0x28, 0x1c },
            new uint[] { 0x90, 0x68, 0x34 },
            new uint[] { 0x90, 0x64, 0x2c },
            new uint[] { 0x94, 0x6c, 0x34 },
            new uint[] { 0x94, 0x70, 0x40 },
            new uint[] { 0x8c, 0x5c, 0x24 },
            new uint[] { 0x90, 0x64, 0x2c },
            new uint[] { 0x90, 0x68, 0x30 },
            new uint[] { 0x98, 0x78, 0x4c },
            new uint[] { 0x60, 0x3c, 0x2c },
            new uint[] { 0x54, 0xa4, 0xa4 },
            new uint[] { 0xc0, 0x0,  0x0 },
            new uint[] { 0xfc, 0x88, 0xe0 },
            new uint[] { 0xfc, 0x58, 0x84 },
            new uint[] { 0xf4, 0x0,  0xc },
            new uint[] { 0xd4, 0x0,  0x0 },
            new uint[] { 0xac, 0x0,  0x0 },
            new uint[] { 0xe8, 0xa8, 0xfc },
            new uint[] { 0xe0, 0x7c, 0xfc },
            new uint[] { 0xd0, 0x3c, 0xfc },
            new uint[] { 0xc4, 0x0,  0xfc },
            new uint[] { 0x90, 0x0,  0xbc },
            new uint[] { 0xfc, 0xf4, 0x7c },
            new uint[] { 0xfc, 0xe4, 0x0 },
            new uint[] { 0xe4, 0xd0, 0x0 },
            new uint[] { 0xa4, 0x98, 0x0 },
            new uint[] { 0x64, 0x58, 0x0 },
            new uint[] { 0xac, 0xfc, 0xa8 },
            new uint[] { 0x74, 0xe4, 0x70 },
            new uint[] { 0x0,  0xbc, 0x0 },
            new uint[] { 0x0,  0xa4, 0x0 },
            new uint[] { 0x0,  0x7c, 0x0 },
            new uint[] { 0xac, 0xa8, 0xfc },
            new uint[] { 0x80, 0x7c, 0xfc },
            new uint[] { 0x0,  0x0,  0xfc },
            new uint[] { 0x0,  0x0,  0xbc },
            new uint[] { 0x0,  0x0,  0x7c },
            new uint[] { 0x30, 0x30, 0x50 },
            new uint[] { 0x28, 0x28, 0x48 },
            new uint[] { 0x24, 0x24, 0x40 },
            new uint[] { 0x20, 0x1c, 0x38 },
            new uint[] { 0x1c, 0x18, 0x34 },
            new uint[] { 0x18, 0x14, 0x2c },
            new uint[] { 0x14, 0x10, 0x24 },
            new uint[] { 0x10, 0xc,  0x20 },
            new uint[] { 0xa0, 0xa0, 0xb4 },
            new uint[] { 0x88, 0x88, 0xa4 },
            new uint[] { 0x74, 0x74, 0x90 },
            new uint[] { 0x60, 0x60, 0x80 },
            new uint[] { 0x50, 0x4c, 0x70 },
            new uint[] { 0x40, 0x3c, 0x60 },
            new uint[] { 0x30, 0x2c, 0x50 },
            new uint[] { 0x24, 0x20, 0x40 },
            new uint[] { 0x18, 0x14, 0x30 },
            new uint[] { 0x10, 0xc,  0x20 },
            new uint[] { 0x14, 0xc,  0x8 },
            new uint[] { 0x18, 0x10, 0xc },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0,  0x0,  0x0 },
            new uint[] { 0x0, 0x0, 0x0 },
        };

        internal void ReadPalette(BinaryReader reader, GfxPaletteInfo paletteInfo)
        {
            reader.BaseStream.Seek(paletteInfo.PaletteOffset, SeekOrigin.Begin);
            for (var i = 0; i < paletteInfo.PaletteColourCount; i++)
            {
                var paletteEntry = reader.ByteToType<GfxPaletteEntry>();

                paletteEntry.MultiplyBy(4);
                this[paletteInfo.FirstPaletteColourIndex + i] = paletteEntry.ToColor();
            }
        }

        public void ResetImage()
        {
            Rgba32 resetColor = new Rgba32(255, 0, 255);
            for (int x = 0; x < Img.Width; x++)
            {
                for (int y = 0; y < Img.Height; y++)
                {
                    Img.GetPixelReference(x, y) = resetColor;
                }
            }
        }

        public int DefaultRleVal { get; set; }
        public Image<Rgba32> Img { get; }

        public Rgba32 this[int i]
        {
            get => new Rgba32((byte)this.palette[i][0], (byte)this.palette[i][1], (byte)this.palette[i][2]);
            set
            {
                this.palette[i][0] = value.R;
                this.palette[i][1] = value.G;
                this.palette[i][2] = value.B;
            }
        }

        public byte this[int x, int y]
        {
            set
            {
                Rgba32 colourCalue = this[value];
                if (colourCalue == new Rgba32(0xFFB4A0A0))
                {
                    Img.GetPixelReference(x, y) = new Rgba32(0xFF00FF00);
                }
                else
                {
                    Img.GetPixelReference(x, y) = colourCalue;
                }
            }
        }
    }
}
